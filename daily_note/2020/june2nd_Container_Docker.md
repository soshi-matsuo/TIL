## コンテナ
### 普及までの状況
システムインフラは、システムコストの削減＆サービス立ち上げの迅速化というモチベーションのもと、計算資源が安価＆高性能になるにつれて、専用コンピュータ→汎用物理サーバ→仮想サーバ→クラウドという変遷をたどってきた。  
仮想化（VM）/クラウド化によってシステムインフラのコストは下がってはいたが、デプロイ面での課題点は残っていた。  
- ゲストOSを含む分イメージのサイズが大きく、他者に配布したり、ネットワーク経由でデプロイしたりするのに不向き  
- サービス起動のためにVM, OS, Middleware, Applicationの全ての起動を待つ必要があり時間がかかる  
- 仮想サーバ（本番環境）と開発環境の差異でデプロイ失敗の可能性がある  
これらを解決するモチベーションでコンテナが利用されるようになった。  
### コンテナ概要
そもそもコンテナとは、**他のプロセスから隔離されたプロセス**のこと。  
具体的にはcgroup(control group), namespaceというLinuxの機能を利用して実現する。
- namespace：プロセス空間、ネットワーク、ファイルシステム等のシステムリソースを、1つのLinuxOS上で分離する機能  
- cgroup：プロセスをグループ化し、各グループにハードウェアのリソースを割り当て管理する機能  
  
動作する際は、コンテナランタイムがコンテナイメージからコンテナを展開・起動することで実行される。  
コンテナイメージは主に以下から構成される。  
- コンテナ（隔離プロセス）からアクセスできるファイル群（依存ライブラリなど）  
- コンテナとして実行するアプリケーション  
- コンテナ実行に必要な設定情報  
  
コンテナランタイムは主に以下を担う。  
- コンテナの起動/終了  
- コンテナのファイルシステム構築  
- namespace&cgroup管理  
  
上述の通り、コンテナはあくまでも、リソース的に隔離された1つのプロセスとして動作し、この特徴により先述のVMの課題点を解決できる。  
- コンテナイメージにOSのカーネルは含まれず、軽量  
- 実行時にゲストOSを立ち上げないので起動が早い  
- 依存ファイルはコンテナが自身のFSに内包するので、VMを利用するより環境の差異が生じにくい  
## Docker
一言でいうとコンテナ管理ソフトウェア。デファクトスタンダード。  
### 概要
Build（イメージの作成）、Ship（イメージの共有）、Run（コンテナの実行）というコンテナライフサイクルをサポートする。  
ホストOS（またはその上のゲストLinux）上にDocker Engineが動作することで、Linuxのコンテナ機能を抽象化して提供している。  
- Docker Engine：Dockerのコアコンポーネントで、dockerd, REST API, docker cliからなるクライアントサーバアプリケーションを指す。  

### アーキテクチャ
- Docker Client：REST APIを介してdockerdに処理を依頼する  
- Docker Host：dockerd(Docker daemon)と、それによって管理されるイメージ、コンテナ等のDockerオブジェクトから成る  
- Dockerイメージ：Dockerコンテナを作成する命令が入った、読み込み専用のテンプレート  
  - 通常、公式が配布するベースイメージを元に作成される  
  - 利用するには、Registry上のものをダウンロードする方法と、自分でビルドする方法がある  
    - 構成要素は親子関係を持つ複数のイメージレイヤ  
    - 各イメージレイヤは、コマンド実行によって生じる直下の親レイヤとの差分を保持する  
    - これらのレイヤは、UnionFileSystemによって利用時には1つのFileSystemに見える  
  - Dockerfile：自らビルドする際に必要なファイルで、これを元にイメージを生成できる  
    - Dockerfileの個々の命令は、1つのイメージレイヤに対応している  
    - 上の行に書かれた命令から実行され、それが親→子の順にレイヤを生成していく  
    - 通常、Dockerfileの内容を書き換えてイメージを再構築する際は変更されたレイヤのみが再生成される  
      - ビルド済みレイヤはキャッシュとして扱えるという性質が、他の仮想化技術に対するイメージの軽量化/高速化に貢献している  
- Dockerコンテナ：Dockerイメージに基づいて生成される、他のプロセスからnamespaceを隔離して実行可能なプロセス  
  - 公式では、イメージの実行状態のインスタンスとも説明される  
  - コンテナへの実行/停止/移動/削除などの操作はDocker APIやCLIで行う  
  - 複数ネットワークへの接続、ストレージの追加、自身の状態を反映したイメージの生成などが可能  
  - 他のコンテナやホストOSとの隔離の程度は制御可能  
  - Dockerコンテナの実行フロー  
    - コンテナの作成：Dockerイメージのレイヤ上に、読み書き可能な新しいイメージレイヤを追加すること  
      - これによってコンテナ稼働中にコンテナ内のファイルシステムへの変更が実現可能  
    - コンテナの実行：コンテナのファイルシステムにあるバイナリを、namespaceを区分けされた特殊なプロセスとして実行すること  
- Docker Registry：Dockerイメージを保管する場所で、`docker pull`, `docker push`で送受信する  
  - パブリックRegistryとして最もポピュラーなのはDocker Hubで、DockerはデフォルトでDocker Hubからイメージを探すようになっている  
  - プライベートRegistryを運用することも可能  
